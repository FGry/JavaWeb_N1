<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quản lý Sản phẩm | BookStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [BẮT ĐẦU CSS Template Admin] */
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sidebar-logo {
            width: 45px;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .sidebar-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }
        .sidebar-menu {
            padding: 20px 0;
        }
        .menu-item {
            display: block;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            position: relative;
        }
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-right: 4px solid white;
        }
        .menu-item i {
            width: 20px;
            margin-right: 15px;
            font-size: 1.1rem;
        }
        .sidebar.collapsed .menu-item {
            padding: 15px;
            text-align: center;
        }
        .sidebar.collapsed .menu-item span {
            display: none;
        }
        .sidebar.collapsed .menu-item i {
            margin-right: 0;
        }
        .sidebar-toggle {
            position: absolute;
            top: 25px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: white;
            border: none;
            border-radius: 50%;
            color: #667eea;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .main-content {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .main-content.expanded {
            margin-left: 80px;
        }
        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between; /* Giữ lại space-between */
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.3rem;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .notification-btn:hover {
            color: #667eea;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 25px;
            transition: background 0.3s ease;
        }

        .user-profile:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-info h6 {
            margin: 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .user-info small {
            color: #6c757d;
        }
        /* Các style cũ của .notification-btn, .user-profile có thể xóa nếu không dùng nữa */
        .dashboard-content {
            padding: 30px;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        .action-left {
            display: flex;
            gap: 15px;
        }
        .action-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-box i {
            position: absolute;
            left: 15px;
            color: #6c757d;
            z-index: 1;
        }
        .search-box input {
            padding: 10px 15px 10px 45px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            width: 300px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-select {
            border-radius: 10px;
            border: 1px solid #dee2e6;
            padding: 10px 15px;
            min-width: 180px;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 25px;
        }
        .table {
            margin: 0;
        }
        .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 20px 15px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }
        .table tbody td {
            padding: 20px 15px;
            border-top: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        .product-image {
            width: 50px;
            height: 75px;
            background: #eee;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 1.2rem;
            flex-shrink: 0;
            object-fit: cover;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 5px;
        }
        .price {
            font-weight: 600;
            color: #28a745;
            font-size: 1rem;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-badge.status-active { background: #e8f5e8; color: #2e7d32; }
        .status-badge.status-low { background: #fff8e1; color: #f57c00; }
        .status-badge.status-empty { background: #ffebee; color: #d32f2f; }
        .action-buttons .btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        #existingImagesPreview img {
            width: 80px;
            height: 120px;
            object-fit: cover;
            margin: 0 5px 5px 0;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            display: inline-block;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-content.expanded { margin-left: 0; }
            .action-bar { flex-direction: column; gap: 15px; align-items: stretch; }
            .action-left, .action-right { justify-content: center; }
            .search-box input { width: 100%; }
            .table-container { overflow-x: auto; }
            .table { min-width: 800px; }
        }
        /* [KẾT THÚC CSS Template Admin] */
    </style>
</head>
<body>
<div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </button>
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-book-open"></i>
        </div>
        <h2 class="sidebar-title">BookStore</h2>
    </div>
    <nav class="sidebar-menu">
        <a th:href="@{/admin/home}" class="menu-item " onclick="showSection('home')">
            <i class="fas fa-box"></i>
            <span>Trang chủ</span>
        <a th:href="@{/admin/products}" class="menu-item active">
            <i class="fas fa-box"></i> <span>Quản lý sản phẩm</span>
        </a>
        <a th:href="@{/admin/carts}" class="menu-item">
            <i class="fas fa-shopping-cart"></i> <span>Quản lý đơn hàng</span>
        </a>
        <a th:href="@{/admin/users}" class="menu-item">
            <i class="fas fa-users"></i> <span>Quản lý tài khoản</span>
        </a>
        <a th:href="@{/admin/vouchers}" class="menu-item">
            <i class="fas fa-ticket-alt"></i> <span>Quản lý voucher</span>
        </a>
        <a th:href="@{/admin/comments}" class="menu-item ">
            <i class="fas fa-star"></i> <span>Quản lý đánh giá</span>
        </a>
        <a th:href="@{/admin/revenue}" class="menu-item">
            <i class="fas fa-chart-line"></i> <span>Thống kê doanh thu</span>
        </a>
        <a th:href="@{/admin/setting}" class="menu-item">
            <i class="fas fa-cog"></i> <span>Cài đặt</span>
        </a>
            <a href="#" class="menu-item" onclick="confirmLogout('/logout')">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
            </a>
    </nav>
</div>

<div class="main-content" id="mainContent">
    <header class="header">
        <div class="header-left">
            <button class="d-md-none btn btn-link" onclick="toggleMobileSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">Quản lý sản phẩm</h1>
        </div>
    </header>
    <div class="dashboard-content fade-in">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            [[${successMessage}]]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            [[${errorMessage}]]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="action-bar">
            <div class="action-left">
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i> Thêm sản phẩm
                </button>
                <button class="btn btn-outline-secondary" onclick="showCategoryModal()" id="manageCategoryBtn">
                    <i class="fas fa-tags"></i> Quản lý danh mục
                </button>
            </div>
            <div class="action-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Tìm kiếm sản phẩm..." id="searchInput" onkeyup="searchProducts()">
                </div>
                <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                    <option value="">Tất cả danh mục</option>
                    <option th:each="category : ${allCategories}"
                            th:value="${category.id_categories}"
                            th:text="${category.name}">Tên Danh mục</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Ảnh</th>
                    <th>Tên sách</th>
                    <th>Tác giả</th>
                    <th>Giá bán</th>
                    <th>Số lượng</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
                </thead>
                <tbody id="productsTableBody">
                <tr th:each="product : ${products}">
                    <td th:text="${product.idProducts}">1</td>
                    <td>
                        <div class="product-image">
                            <img th:if="${product.imageLinks != null and not #lists.isEmpty(product.imageLinks)}"
                                 th:src="${product.imageLinks[0]}"
                                 alt="Product Image">
                            <i th:unless="${product.imageLinks != null and not #lists.isEmpty(product.imageLinks)}" class="fas fa-book"></i>
                        </div>
                    </td>
                    <td>
                        <div style="gap: 0; align-items: flex-start;">
                            <h6 th:text="${product.title}" style="margin: 0 0 5px; font-weight: 600; color: #2c3e50;">Tên Sản phẩm</h6>
                            <small class="text-muted">Danh mục:
                                <span th:each="catName, stat : ${product.categoryNames}">
                                            [[${catName}]]<span th:if="${!stat.last}">, </span>
                                        </span>
                            </small>
                        </div>
                    </td>
                    <td th:text="${product.author}"
                        th:attr="data-category-ids=${!#lists.isEmpty(product.selectedCategoryIds) ? #strings.listJoin(product.selectedCategoryIds, ',') : ''}">Tác giả</td>
                    <td class="price" th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'POINT')} + ' VNĐ'">₫180,000</td>
                    <td th:text="${product.stockQuantity}">45</td>
                    <td>
                        <span class="status-badge"
                              th:classappend="${product.stockQuantity > 20} ? 'status-active' : (${product.stockQuantity > 0} ? 'status-low' : 'status-empty')"
                              th:text="${product.stockQuantity > 20} ? 'Còn hàng' : (${product.stockQuantity > 0} ? 'Sắp hết' : 'Hết hàng')">
                            Còn hàng
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info" th:attr="onclick=|viewProductDetail(${product.idProducts})|" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning"
                                    th:attr="onclick=|editProduct(${product.idProducts})|"
                                    title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    th:attr="onclick=|confirmDeleteProduct(${product.idProducts})|"
                                    title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <p class="pagination-info">Hiển thị 1 đến 10 trong tổng số 50 sản phẩm</p>
        </div>
    </div>
</div>

<div class="modal fade" id="productFormModal" tabindex="-1" aria-labelledby="productFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productFormModalLabel">Thêm sản phẩm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/admin/products/save}" method="post" th:object="${product}" enctype="multipart/form-data" id="productForm">
                    <input type="hidden" th:field="*{idProducts}" id="product_idProducts">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="product_title" class="form-label">Tên sách</label>
                                <input type="text" th:field="*{title}" class="form-control" id="product_title" required>
                            </div>
                            <div class="mb-3 row">
                                <div class="col-6">
                                    <label for="product_author" class="form-label">Tác giả</label>
                                    <input type="text" th:field="*{author}" class="form-control" id="product_author">
                                </div>
                                <div class="col-6">
                                    <label for="product_publisher" class="form-label">Nhà xuất bản</label>
                                    <input type="text" th:field="*{publisher}" class="form-control" id="product_publisher">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <div class="col-4">
                                    <label for="product_price" class="form-label">Giá bán (VNĐ)</label>
                                    <input type="number" th:field="*{price}" class="form-control" id="product_price" required min="0">
                                </div>
                                <div class="col-4">
                                    <label for="product_discount" class="form-label">Giảm giá (%)</label>
                                    <input type="number" th:field="*{discount}" class="form-control" id="product_discount" min="0" max="100">
                                </div>
                                <div class="col-4">
                                    <label for="product_stockQuantity" class="form-label">Số lượng tồn</label>
                                    <input type="number" th:field="*{stockQuantity}" class="form-control" id="product_stockQuantity" required min="0">
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <div class="col-4">
                                    <label for="product_publicationYear" class="form-label">Năm xuất bản</label>
                                    <input type="date" th:field="*{publicationYear}" class="form-control" id="product_publicationYear">
                                </div>
                                <div class="col-4">
                                    <label for="product_pages" class="form-label">Số trang</label>
                                    <input type="number" th:field="*{pages}" class="form-control" id="product_pages" min="1">
                                </div>
                                <div class="col-4">
                                    <label for="product_language" class="form-label">Ngôn ngữ</label>
                                    <input type="text" th:field="*{language}" class="form-control" id="product_language">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="product_category" class="form-label">Danh mục</label>
                                <select th:field="*{selectedCategoryIds}" class="form-select" id="product_category" multiple required>
                                    <option th:each="category : ${allCategories}"
                                            th:value="${category.id_categories}"
                                            th:text="${category.name}">Tên Danh mục</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="product_description" class="form-label">Mô tả sản phẩm</label>
                        <textarea class="form-control" th:field="*{description}" id="product_description" rows="4" placeholder="Nhập mô tả chi tiết của sách..."></textarea>
                    </div>

                    <div class="mb-3 mt-4 border p-3 rounded bg-light">
                        <label for="product_imageFiles" class="form-label fw-bold">Hình ảnh sản phẩm</label>
                        <div id="existingImagesPreview" class="mb-2"></div>
                        <input class="form-control" type="file" id="product_imageFiles"
                               name="imageFiles" multiple accept="image/*">
                        <small class="text-muted d-block mt-1">Có thể chọn nhiều ảnh. Tải ảnh mới sẽ *thay thế* toàn bộ ảnh cũ.</small>
                    </div>

                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Lưu sản phẩm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryManageModal" tabindex="-1" aria-labelledby="categoryManageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryManageModalLabel">Quản lý Danh mục</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="categoryAlert"></div>

                <form id="categoryFormManage" class="mb-3 border p-3 rounded bg-light">
                    <h6>Thêm/Sửa Danh Mục</h6>
                    <input type="hidden" id="category_idCategories" name="idCategories">

                    <div class="mb-3">
                        <label for="category_name" class="form-label">Tên Danh mục</label>
                        <input type="text" class="form-control" id="category_name" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="category_description" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="category_description" name="description" rows="2"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Lưu Danh mục</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="categoryFormManage.reset(); document.getElementById('category_idCategories').value='';">Hủy bỏ</button>
                </form>

                <h6>Danh sách hiện có</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm" id="categoryTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên Danh mục</th>
                            <th>Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="categoryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailModalLabel">Chi tiết Sản phẩm: <span id="productDetailTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5">
                        <div id="productDetailImages" class="mb-3">
                            <img src="" alt="Ảnh sản phẩm chính" class="img-fluid border rounded" id="mainProductImage">
                        </div>
                    </div>
                    <div class="col-md-7">
                        <table class="table table-sm table-striped">
                            <tbody>
                            <tr><th>ID</th><td id="detailId"></td></tr>
                            <tr><th>Tên sách</th><td id="detailTitle"></td></tr>
                            <tr><th>Tác giả</th><td id="detailAuthor"></td></tr>
                            <tr><th>Nhà xuất bản</th><td id="detailPublisher"></td></tr>
                            <tr><th>Giá (VNĐ)</th><td id="detailPrice"></td></tr>
                            <tr><th>Giảm giá (%)</th><td id="detailDiscount"></td></tr>
                            <tr><th>Tồn kho</th><td id="detailStock"></td></tr>
                            <tr><th>Năm XB</th><td id="detailYear"></td></tr>
                            <tr><th>Ngôn ngữ</th><td id="detailLanguage"></td></tr>
                            <tr><th>Danh mục</th><td id="detailCategories"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <h6 class="mt-3">Mô tả</h6>
                <p class="text-muted" id="detailDescription"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function confirmLogout(logoutUrl) {
        // Sử dụng hàm confirm() gốc của trình duyệt
        if (confirm("Bạn có chắc chắn muốn đăng xuất khỏi hệ thống quản trị không?")) {
            // Nếu người dùng nhấn OK, chuyển hướng đến URL đăng xuất
            window.location.href = logoutUrl;
        }
        // Nếu người dùng nhấn Cancel, không làm gì cả
    }
    // --- KHỞI TẠO CHUNG ---
    const productFormModalElement = document.getElementById('productFormModal');
    const productFormModal = new bootstrap.Modal(productFormModalElement);
    const productForm = document.getElementById('productForm');
    const modalTitle = document.getElementById('productFormModalLabel');
    const categorySelect = document.getElementById('product_category');
    const imageFilesInput = document.getElementById('product_imageFiles');
    const existingImagesPreview = document.getElementById('existingImagesPreview');


    // Khởi tạo cho Category Management
    const categoryManageModal = new bootstrap.Modal(document.getElementById('categoryManageModal'));
    const categoryFormManage = document.getElementById('categoryFormManage');
    const categoryTableBody = document.querySelector('#categoryTable tbody');
    const categoryAlert = document.getElementById('categoryAlert');

    // Khởi tạo cho Product Detail
    const productDetailModalElement = document.getElementById('productDetailModal');
    const productDetailModal = new bootstrap.Modal(productDetailModalElement);


    // === PHẦN QUAN TRỌNG: MỞ LẠI MODAL KHI CÓ LỖI ===
    document.addEventListener('DOMContentLoaded', (event) => {
        var shouldOpenModal = /*[[${openFormModal}]]*/ false;
        if (shouldOpenModal) {
            console.log("Mở lại form modal do có lỗi validation.");
            const productId = document.getElementById('product_idProducts').value;
            if (productId && productId.length > 0) {
                modalTitle.textContent = "Chỉnh sửa sản phẩm";
                existingImagesPreview.innerHTML = '<small class="text-danger">Lỗi. Vui lòng chọn lại ảnh nếu muốn thay đổi.</small>';
            } else {
                modalTitle.textContent = "Thêm sản phẩm mới";
            }
            productFormModal.show();
        }
    });
    // === KẾT THÚC PHẦN THÊM ===


    // --- LOGIC SẢN PHẨM ---

    function showAddProductModal() {
        modalTitle.textContent = "Thêm sản phẩm mới";
        productForm.reset();
        document.getElementById('product_idProducts').value = '';
        document.getElementById('product_language').value = 'Tiếng Việt'; // Set default
        document.getElementById('product_discount').value = 0; // Set default
        document.getElementById('product_description').value = ''; // Reset description
        Array.from(categorySelect.options).forEach(option => option.selected = false);
        imageFilesInput.value = null;
        existingImagesPreview.innerHTML = '';
        productFormModal.show();
    }

    function editProduct(id) {
        modalTitle.textContent = "Chỉnh sửa sản phẩm";
        productForm.reset();
        existingImagesPreview.innerHTML = '';

        fetch(`/admin/products/edit/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Lỗi khi lấy dữ liệu sản phẩm: ' + response.statusText);
                return response.json();
            })
            .then(product => {
                document.getElementById('product_idProducts').value = product.idProducts;
                document.getElementById('product_title').value = product.title;
                document.getElementById('product_author').value = product.author || '';
                document.getElementById('product_publisher').value = product.publisher || '';
                document.getElementById('product_price').value = product.price;
                document.getElementById('product_discount').value = product.discount || 0;
                document.getElementById('product_stockQuantity').value = product.stockQuantity;
                document.getElementById('product_pages').value = product.pages || '';
                document.getElementById('product_language').value = product.language || 'Tiếng Việt';
                document.getElementById('product_publicationYear').value = product.publicationYear || '';
                document.getElementById('product_description').value = product.description || ''; // Điền mô tả

                const selectedIds = product.selectedCategoryIds || [];
                Array.from(categorySelect.options).forEach(option => {
                    option.selected = selectedIds.includes(parseInt(option.value));
                });

                imageFilesInput.value = null;
                if (product.imageLinks && Array.isArray(product.imageLinks) && product.imageLinks.length > 0) {
                    existingImagesPreview.innerHTML = '<h6>Ảnh hiện tại:</h6>';
                    product.imageLinks.forEach(link => {
                        const img = document.createElement('img');
                        img.src = link;
                        existingImagesPreview.appendChild(img);
                    });
                } else {
                    existingImagesPreview.innerHTML = '<small>Không có ảnh hiện tại.</small>';
                }

                productFormModal.show();
            })
            .catch(error => {
                console.error('Lỗi khi tải chi tiết sản phẩm:', error);
                alert('Không thể tải dữ liệu sản phẩm để sửa.');
            });
    }

    function confirmDeleteProduct(id) {
        if (confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA SẢN PHẨM ID ' + id + ' NÀY KHÔNG?')) {
            window.location.href = `/admin/products/delete/${id}`;
        }
    }

    function viewProductDetail(id) {
        console.log('--- ATTEMPTING TO VIEW DETAIL FOR ID:', id, '---');

        fetch(`/admin/products/edit/${id}`)
            .then(response => {
                if (!response.ok) {
                    console.error('Server responded with an error:', response.status);
                    throw new Error('API Error: Không tải được chi tiết sản phẩm. Status: ' + response.status);
                }
                return response.json();
            })
            .then(product => {
                console.log('Product data:', product);

                try {
                    const priceToFormat = product.price != null ? product.price : 0;
                    const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(priceToFormat);
                    document.getElementById('productDetailTitle').innerText = product.title;
                    document.getElementById('detailId').innerText = product.idProducts;
                    document.getElementById('detailTitle').innerText = product.title;
                    document.getElementById('detailAuthor').innerText = product.author || 'N/A';
                    document.getElementById('detailPublisher').innerText = product.publisher || 'N/A';
                    document.getElementById('detailPrice').innerText = formattedPrice;
                    document.getElementById('detailDiscount').innerText = (product.discount || 0) + '%';
                    document.getElementById('detailStock').innerText = product.stockQuantity;
                    document.getElementById('detailYear').innerText = product.publicationYear || 'N/A';
                    document.getElementById('detailLanguage').innerText = product.language || 'N/A';

                    const categories = product.categoryNames ? product.categoryNames.join(', ') : 'Không có';
                    document.getElementById('detailCategories').innerText = categories;
                    document.getElementById('detailDescription').innerText = product.description || 'Chưa có mô tả.';

                    const mainImageElement = document.getElementById('mainProductImage');
                    if (product.imageLinks && product.imageLinks.length > 0) {
                        mainImageElement.src = product.imageLinks[0];
                    } else {
                        mainImageElement.src = 'https://via.placeholder.com/300x450?text=No+Image';
                    }

                    productDetailModal.show();
                    console.log('SUCCESS: Modal chi tiết sản phẩm đã được hiển thị.');
                } catch (e) {
                    console.error('LỖI DOM BINDING HOẶC DỮ LIỆU:', e);
                    alert('Lỗi hiển thị dữ liệu trong modal. Kiểm tra console để biết chi tiết.');
                }
            })
            .catch(error => {
                console.error('LỖI FETCH TỪ SERVER:', error);
                alert('Không thể xem chi tiết. Vui lòng kiểm tra console log (F12) để biết lỗi API.');
            });
    }

    // --- LOGIC DANH MỤC (Không đổi) ---
    function showCategoryAlert(message, type = 'success') {
        categoryAlert.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                      ${message}
                                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                  </div>`;
    }
    function showCategoryModal() {
        categoryManageModal.show();
        loadCategories();
    }
    function loadCategories() {
        categoryAlert.innerHTML = '';
        fetch('/admin/categories/all')
            .then(response => {
                if (!response.ok) throw new Error('Lỗi khi tải danh sách danh mục.');
                return response.json();
            })
            .then(categories => {
                categoryTableBody.innerHTML = '';
                categories.forEach(category => {
                    const row = categoryTableBody.insertRow();
                    row.innerHTML = `
                        <td>${category.idCategories}</td>
                        <td>${category.name}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" onclick="editCategory(${category.idCategories})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory(${category.idCategories})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            })
            .catch(error => {
                console.error('Lỗi tải danh mục:', error);
                showCategoryAlert('Không thể tải danh mục. Kiểm tra console và Controller.', 'danger');
            });
    }
    function editCategory(id) {
        fetch(`/admin/categories/edit/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Lỗi khi lấy chi tiết danh mục.');
                return response.json();
            })
            .then(category => {
                document.getElementById('category_idCategories').value = category.idCategories;
                document.getElementById('category_name').value = category.name;
                document.getElementById('category_description').value = category.description || '';
                categoryFormManage.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Lỗi tải chi tiết danh mục:', error);
                showCategoryAlert('Không thể tải chi tiết danh mục để sửa.', 'danger');
            });
    }
    categoryFormManage.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = {
            idCategories: document.getElementById('category_idCategories').value || null,
            name: document.getElementById('category_name').value,
            description: document.getElementById('category_description').value
        };
        fetch('/admin/categories/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify(formData)
        })
            .then(async response => {
                if (response.ok) {
                    showCategoryAlert('Lưu danh mục thành công!', 'success');
                    categoryFormManage.reset();
                    document.getElementById('category_idCategories').value = '';
                    updateCategoryDropdown();
                    loadCategories();
                } else {
                    const errorText = await response.text();
                    showCategoryAlert(`Lưu danh mục thất bại. Chi tiết: ${errorText}`, 'danger');
                    console.error('Lỗi lưu danh mục:', response.status, errorText);
                }
            })
            .catch(error => {
                showCategoryAlert('Lỗi mạng hoặc kết nối server. Vui lòng kiểm tra console.', 'danger');
                console.error('Fetch error:', error);
            });
    });
    function deleteCategory(id) {
        if (!confirm(`Bạn có chắc chắn muốn xóa Danh mục ID ${id} này?`)) { return; }
        fetch(`/admin/categories/delete/${id}`, { method: 'DELETE', })
            .then(async response => {
                if (response.ok) {
                    showCategoryAlert(`Xóa danh mục ID ${id} thành công!`, 'success');
                    updateCategoryDropdown();
                    loadCategories();
                } else {
                    const errorText = await response.text();
                    showCategoryAlert(`Xóa danh mục thất bại. Chi tiết: ${errorText}`, 'danger');
                    console.error('Lỗi xóa danh mục:', response.status, errorText);
                }
            })
            .catch(error => {
                showCategoryAlert('Lỗi mạng hoặc kết nối server khi xóa.', 'danger');
                console.error('Fetch error during delete:', error);
            });
    }
    function updateCategoryDropdown() {
        fetch('/admin/categories/all')
            .then(response => response.json())
            .then(categories => {
                const categorySelectForm = document.getElementById('product_category');
                const categorySelectFilter = document.getElementById('categoryFilter');
                categorySelectForm.innerHTML = '';
                categorySelectFilter.innerHTML = '<option value="">Tất cả danh mục</option>';
                categories.forEach(category => {
                    const optionForm = document.createElement('option');
                    optionForm.value = category.idCategories;
                    optionForm.textContent = category.name;
                    categorySelectForm.appendChild(optionForm);
                    const optionFilter = document.createElement('option');
                    optionFilter.value = category.idCategories;
                    optionFilter.textContent = category.name;
                    categorySelectFilter.appendChild(optionFilter);
                });
            })
            .catch(error => console.error('Lỗi cập nhật dropdown danh mục:', error));
    }

    // --- LỌC VÀ TÌM KIẾM (Không đổi) ---
    function searchProducts() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('productsTableBody');
        const rows = table.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const titleCell = rows[i].getElementsByTagName('td')[2];
            const authorCell = rows[i].getElementsByTagName('td')[3];
            let matches = false;
            if (titleCell) {
                const titleText = titleCell.textContent || titleCell.innerText;
                if (titleText.toUpperCase().indexOf(filter) > -1) { matches = true; }
            }
            if (authorCell) {
                const authorText = authorCell.textContent || authorCell.innerText;
                if (authorText.toUpperCase().indexOf(filter) > -1) { matches = true; }
            }
            rows[i].style.display = matches ? "" : "none";
        }
    }
    function filterByCategory() {
        const select = document.getElementById('categoryFilter');
        const categoryId = select.value;
        const rows = document.getElementById('productsTableBody').getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const categoryAttr = rows[i].getElementsByTagName('td')[3].getAttribute('data-category-ids');
            if (categoryId === "") {
                rows[i].style.display = "";
            } else if (categoryAttr && categoryAttr.includes(categoryId)) {
                rows[i].style.display = "";
            } else {
                rows[i].style.display = "none";
            }
        }
    }

    // --- CÁC HÀM CHUNG KHÁC (Không đổi) ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
        document.getElementById('mainContent').classList.toggle('expanded');
        const icon = document.getElementById('toggleIcon');
        if (document.getElementById('sidebar').classList.contains('collapsed')) {
            icon.classList.remove('fa-chevron-left');
            icon.classList.add('fa-chevron-right');
        } else {
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-left');
        }
    }
    function toggleMobileSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
    }
    // Xóa hàm JS không dùng nữa
    // function showNotifications() { console.log('Show notifications'); }
    // function showUserMenu() { console.log('Show user menu'); }
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98aa38c6e58208dd',t:'MTc1OTgwNjc5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else window.attachEvent('onload',c)}})();</script>
</body>
</html>